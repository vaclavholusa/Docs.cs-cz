---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Použití rozhraní Entity Framework 4.0 a ovládací prvek ObjectDataSource, 2. část: přidání vrstvy obchodní logiky a testy jednotek | Dokumentace Microsoftu'
author: tdykstra
description: V této sérii kurzů staví na Contoso University webovou aplikaci, která se vytvořila Začínáme s Entity Framework 4.0 série kurzů. I...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
ms.technology: dotnet-webforms
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 02f0b86203eb879ca618655b8956f22dc67858cd
ms.sourcegitcommit: 953ff9ea4369f154d6fd0239599279ddd3280009
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 07/03/2018
ms.locfileid: "37394239"
---
<a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="3f5e0-104">Použití rozhraní Entity Framework 4.0 a ovládací prvek ObjectDataSource, 2. část: přidání vrstvy obchodní logiky a testy jednotek</span><span class="sxs-lookup"><span data-stu-id="3f5e0-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>
====================
<span data-ttu-id="3f5e0-105">podle [Petr Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="3f5e0-106">V této sérii kurzů staví na Contoso University webovou aplikaci, která se vytvořila [Začínáme s Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) série kurzů.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="3f5e0-107">Pokud nebyla dokončena v předchozích kurzech, jako výchozí bod pro účely tohoto kurzu můžete [stáhnout aplikaci](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) , kterou by jste vytvořili.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="3f5e0-108">Můžete také [stáhnout aplikaci](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , který vytvoří kompletní série kurzů.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="3f5e0-109">Pokud máte dotazy týkající se těchto kurzů, můžete je publikovat [fórum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="3f5e0-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="3f5e0-110">V předchozím kurzu jste vytvořili vícevrstvou webovou aplikaci pomocí rozhraní Entity Framework a `ObjectDataSource` ovládacího prvku.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="3f5e0-111">Tento kurz ukazuje, jak přidat obchodní logiky a zajistit přitom ochranu vrstvy obchodní logiky (BLL) a přístup k datům layer (DAL) samostatné a ukazuje, jak vytvořit automatizované testy jednotky pro BLL.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="3f5e0-112">V tomto kurzu budete provádět následující úlohy:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="3f5e0-113">Vytvoření rozhraní úložiště, který deklaruje metody přístupu k datům, které potřebujete.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="3f5e0-114">Implementujte rozhraní úložiště v třídě úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="3f5e0-115">Vytvořte třídu obchodní logiky, který zavolá třídu úložiště k provádění funkcí přístup k datům.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="3f5e0-116">Připojení `ObjectDataSource` ovládací prvek do třídy obchodní logiku místo pro třídu úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="3f5e0-117">Vytvořte projekt testování částí a třídy úložiště, který používá kolekce v paměti pro své datové úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="3f5e0-118">Vytvoření testování částí pro obchodní logiku, kterou chcete přidat do třídy obchodní logiku, pak spusťte test a prohlédněte si nezdaří.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="3f5e0-119">Implementovat obchodní logiku v třídě obchodní logiku, a poté znovu spusťte test jednotky a podívat, jak to předat.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="3f5e0-120">Budete pracovat *Departments.aspx* a *DepartmentsAdd.aspx* stránky, které jste vytvořili v předchozím kurzu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="3f5e0-121">Vytvoření rozhraní pro úložiště</span><span class="sxs-lookup"><span data-stu-id="3f5e0-121">Creating a Repository Interface</span></span>

<span data-ttu-id="3f5e0-122">Zobrazí za přibližně tak, že vytvoříte rozhraní úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="3f5e0-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="3f5e0-124">V *DAL* složku, vytvořte nový soubor třídy, pojmenujte ho *ISchoolRepository.cs*a nahraďte existující kód následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="3f5e0-125">Rozhraní definuje jednu metodu pro každou CRUD (vytváření, čtení, aktualizace nebo odstranění) metody, které jste vytvořili v třídě úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="3f5e0-126">V `SchoolRepository` třídy v *SchoolRepository.cs*, označení, že tato třída implementuje `ISchoolRepository` rozhraní:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="3f5e0-127">Vytvoření třídy obchodní logiky</span><span class="sxs-lookup"><span data-stu-id="3f5e0-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="3f5e0-128">V dalším kroku vytvoříte třídu obchodní logiku.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="3f5e0-129">To provedete tak, aby můžete přidat obchodní logiky, která se spustí `ObjectDataSource` řídit, přestože to není, ještě.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="3f5e0-130">Prozatím novou třídu obchodní logiku pouze provede stejné operace CRUD, které nemá úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="3f5e0-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="3f5e0-132">Vytvořte novou složku s názvem *BLL*.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="3f5e0-133">(V reálné aplikaci byste vrstvy obchodní logiky obvykle implementován jako knihovna tříd – samostatný projekt, ale pro zjednodušení tento kurz se zachová BLL třídy ve složce projektu.)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="3f5e0-134">V *BLL* složku, vytvořte nový soubor třídy, pojmenujte ho *SchoolBL.cs*a nahraďte existující kód následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="3f5e0-135">Tento kód vytvoří stejné metody CRUD, které jste viděli dříve v třídě úložiště, ale ne přístup přímo metody rozhraní Entity Framework, volá úložiště metody třídy.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="3f5e0-136">Proměnné třídy, která obsahuje odkaz na třídu úložiště je definována jako typ rozhraní a kód, který vytvoří instanci třídy úložiště je obsažený v dva konstruktory.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="3f5e0-137">Konstruktor bez parametrů použije `ObjectDataSource` ovládacího prvku.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="3f5e0-138">Vytvoří instanci `SchoolRepository` třídu, která jste vytvořili dříve.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="3f5e0-139">Další konstruktor umožňuje jakýkoli kód, který vytvoří instanci třídy obchodní logiky a zajistěte tak předání libovolný objekt, který implementuje rozhraní úložiště.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="3f5e0-140">CRUD metody, které volají třídu úložiště a dva konstruktory umožňují použít třídu obchodní logiky pomocí libovolné úložiště back endovým datům zvolíte.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="3f5e0-141">Třída obchodní logiku nemusí vědět jak třídu, která je volání přenese data.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="3f5e0-142">(To se často nazývá *trvalost neznalosti*.) To usnadňuje testování částí, protože třída obchodní logiku se můžete připojit k úložišti implementace, která používá něco jako jednoduchá jako v paměti `List` kolekce a ukládat data.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="3f5e0-143">Objekty entity jsou technicky vzato stále není ignorujících, protože při vytváření instance ze tříd, které dědí z rozhraní Entity Framework `EntityObject` třídy.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="3f5e0-144">Pro dokončení trvalost neznalosti, můžete použít *prostý starší objekty CLR*, nebo *POCOs*, místo objekty, které dědí `EntityObject` třídy.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="3f5e0-145">Použití POCOs je nad rámec tohoto kurzu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="3f5e0-146">Další informace najdete v tématu [testovatelnost a Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) na webu MSDN.)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>


<span data-ttu-id="3f5e0-147">Teď se můžete připojit `ObjectDataSource` ovládacích prvků pro obchodní logiku místo na třídě k úložišti a ověřte, že vše funguje stejně jako dříve.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="3f5e0-148">V *Departments.aspx* a *DepartmentsAdd.aspx*, změňte všechny výskyty `TypeName="ContosoUniversity.DAL.SchoolRepository"` k `TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="3f5e0-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="3f5e0-149">(Existují čtyři instance ve všech).</span><span class="sxs-lookup"><span data-stu-id="3f5e0-149">(There are four instances in all.)</span></span>

<span data-ttu-id="3f5e0-150">Spustit *Departments.aspx* a *DepartmentsAdd.aspx* stránky k ověření, že jsou i nadále fungovat jako před nástupem prostředí.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="3f5e0-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="3f5e0-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="3f5e0-153">Vytvoření projektu testování částí a implementace úložiště</span><span class="sxs-lookup"><span data-stu-id="3f5e0-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="3f5e0-154">Přidat nový projekt do řešení pomocí **testovací projekt** šablony a pojmenujte ho `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="3f5e0-155">V testovacím projektu přidejte odkaz na `System.Data.Entity` a přidejte odkaz na projekt `ContosoUniversity` projektu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="3f5e0-156">Nyní můžete vytvořit třídu úložiště, které budete používat s testy jednotek.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="3f5e0-157">Úložiště dat pro toto úložiště bude v rámci třídy.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="3f5e0-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="3f5e0-159">V testovacím projektu vytvořte nový soubor třídy, pojmenujte ho *MockSchoolRepository.cs*a nahraďte existující kód následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="3f5e0-160">Tato třída úložiště má stejné metody CRUD jako ten, který má přístup k rozhraní Entity Framework přímo, ale při práci s `List` kolekce v paměti, nikoli s databází.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="3f5e0-161">Díky tomu snadněji pro testovací třídu k nastavení a ověření testů jednotek pro třídu obchodní logiku.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="3f5e0-162">Vytváření testů jednotek</span><span class="sxs-lookup"><span data-stu-id="3f5e0-162">Creating Unit Tests</span></span>

<span data-ttu-id="3f5e0-163">**Testování** šablona projektu pro vás vytvořili třídu testu jednotek se zakázaným inzerováním a dalším úkolem je upravit tak, že přidáte metody jednotkového testu k němu pro obchodní logiku, kterou chcete přidat do třídy obchodní logiku této třídy.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="3f5e0-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="3f5e0-165">Na univerzitě Contoso jakékoli jednotlivých kurzů vedených lze pouze správce jednoho oddělení a je třeba přidat obchodní logiku a vynuťte si toto pravidlo.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="3f5e0-166">Začněte přidáním testů a spuštění testů, zobrazíte jejich selhání.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="3f5e0-167">Potom přidejte kód a znovu spusťte testy, byl očekáván zobrazíte jejich předávání.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="3f5e0-168">Otevřít *UnitTest1.cs* a přidejte `using` příkazy pro obchodní logika a přístup k datům vrstvy, které jste vytvořili v projektu ContosoUniversity:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="3f5e0-169">Nahradit `TestMethod1` metoda pomocí následujících metod:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="3f5e0-170">`CreateSchoolBL` Metoda vytvoří instanci třídy úložiště, který jste vytvořili pro projekt, který pak předá do nové instance třídy obchodní logiky testování jednotek.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="3f5e0-171">Metoda pak používá třídu obchodní logiku pro vložení tří oddělení, které můžete použít v testovacích metod.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="3f5e0-172">Testovacích metod ověřte, že třída obchodní logiku vyvolá výjimku, pokud se někdo pokusí vložit nové oddělení stejné správce jako existující oddělení, nebo když se někdo pokusí aktualizovat oddělení správce tak, že ji nastavíte na ID osoby kdo je již správce jiného oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="3f5e0-173">Zatím jste ještě nevytvořili třídy výjimek, takže tento kód nebude kompilovat.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="3f5e0-174">K jeho kompilace klikněte pravým tlačítkem na `DuplicateAdministratorException` a vyberte **generovat**a potom **třídy**.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="3f5e0-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="3f5e0-176">Tím se vytvoří třídu v projektu testu, které lze odstranit po vytvoření třídy výjimek v hlavním projektem.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="3f5e0-177">a implementovat obchodní logiku.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-177">and implemented the business logic.</span></span>

<span data-ttu-id="3f5e0-178">Spuštění projektu testů.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-178">Run the test project.</span></span> <span data-ttu-id="3f5e0-179">Podle očekávání, selhání testů.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-179">As expected, the tests fail.</span></span>

<span data-ttu-id="3f5e0-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="3f5e0-181">Přidání obchodní logiky, aby průchodu testu</span><span class="sxs-lookup"><span data-stu-id="3f5e0-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="3f5e0-182">V dalším kroku budete implementovat obchodní logiku, která znemožňuje nastavit jako správce oddělení někoho, kdo je již správce jiného oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="3f5e0-183">Budete vyvolat výjimku z vrstvy obchodní logiky a když uživatel upraví oddělení a klikne na tlačítko ji zachytit v prezentační vrstvě **aktualizace** po výběru uživatele, který je již správce.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="3f5e0-184">(Můžete také odebrat Instruktoři z rozevíracího seznamu, kteří už jsou administrators, před vykreslení stránky, ale účelem toho všeho je pro práci s vrstvy obchodní logiky.)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="3f5e0-185">Začněte vytvořením třídy výjimek, který budete vyvolat, když se uživatel pokusí provést instruktorem správce více než jednom oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="3f5e0-186">V hlavním projektu vytvořte nový soubor třídy v *BLL* složky, pojmenujte ho *DuplicateAdministratorException.cs*a nahraďte existující kód následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="3f5e0-187">Nyní odstranit dočasný *DuplicateAdministratorException.cs* soubor, který jste vytvořili v testovacím projektu. aby bylo možné zkompilovat.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="3f5e0-188">V hlavním projektu, otevřete *SchoolBL.cs* a přidejte následující metodu, která obsahuje logiku ověřování.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="3f5e0-189">(Kód odkazuje na metodu, kterou vytvoříte později.)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="3f5e0-190">Budete volat tuto metodu při vkládání nebo aktualizaci `Department` entity za účelem ověření, zda jiného oddělení již má stejné správce.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="3f5e0-191">Kód volá metodu pro vyhledávání v databázi `Department` entita, která má stejnou `Administrator` hodnota vlastnosti jako entity se přidají nebo aktualizují.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="3f5e0-192">Pokud ho najde, kód vyvolá výjimku.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="3f5e0-193">Žádné kontroly ověřování je vyžadována, pokud nemá žádné entity, které se přidají nebo aktualizují `Administrator` hodnotu a žádná výjimka je vyvolána, pokud metoda je volána v průběhu aktualizace a `Department` entity nalezených shod `Department` aktualizuje entitu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="3f5e0-194">Zavolat novou metodu z `Insert` a `Update` metody:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="3f5e0-195">V *ISchoolRepository.cs*, přidejte následující deklarace pro novou metodu přístupu k datům:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="3f5e0-196">V *SchoolRepository.cs*, přidejte následující `using` – příkaz:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="3f5e0-197">V *SchoolRepository.cs*, přidejte následující novou metodu přístupu k datům:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="3f5e0-198">Tento kód načte `Department` entity, které mají zadanou správce.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="3f5e0-199">Pouze jeden oddělení by měl nalezen (pokud existuje).</span><span class="sxs-lookup"><span data-stu-id="3f5e0-199">Only one department should be found (if any).</span></span> <span data-ttu-id="3f5e0-200">Ale protože je do databáze bez omezení, návratový typ je kolekce v případě, že nejsou nalezeny několika oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="3f5e0-201">Ve výchozím nastavení, když do kontextu objektu načte entity z databáze, ji uchovává informace o jejich v jeho správce stavu objektu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="3f5e0-202">`MergeOption.NoTracking` Parametr určuje, že nebude pro tento dotaz provést toto sledování.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="3f5e0-203">To je nezbytné, protože dotaz může vrátit přesné entity, který se pokoušíte aktualizovat, a pak jste nemohli připojit dané entitě.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="3f5e0-204">Pokud upravíte historie oddělení například *Departments.aspx* stránky a nechte beze změny správce, tento dotaz vrátí oddělení historie.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="3f5e0-205">Pokud `NoTracking` není nastaven, kontext objektu by už máte entity oddělení historie v jeho správce stavu objektu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="3f5e0-206">Potom po připojení entity oddělení historie, která se znovu vytvoří ze zobrazení stavu kontextu objektu by vyvolat výjimku, která uvádí, že `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="3f5e0-207">(Jako alternativu k určení `MergeOption.NoTracking`, můžete vytvořit nový objekt kontextu pouze pro tento dotaz.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="3f5e0-208">Vzhledem k tomu, že nový kontext objektu bude mít své vlastní správce stavu objektu, nedojde ke konfliktu při volání `Attach` metody.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="3f5e0-209">Nový kontext objektu by sdílet metadata a databáze připojení původní objekt kontextu, takže snížení výkonu v důsledku tomto alternativním postupu bude minimální.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="3f5e0-210">Tento přístup je znázorněno zde, ale zavádí `NoTracking` možnost, která bude pro vás být užitečné v jiném kontextu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="3f5e0-211">Tím `NoTracking` možnost je popsána dále v pozdějších kurzech v této sérii.)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="3f5e0-212">V testovacím projektu přidejte novou metodu přístupu k datům na *MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="3f5e0-213">Tento kód používá k provedení stejné výběr dat LINQ, který `ContosoUniversity` používá technologii LINQ to Entities pro úložiště projektu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="3f5e0-214">Znovu spusťte testovací projekt.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-214">Run the test project again.</span></span> <span data-ttu-id="3f5e0-215">Tentokrát testy jsou úspěšné.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-215">This time the tests pass.</span></span>

<span data-ttu-id="3f5e0-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="3f5e0-217">Zpracování výjimek v prvku ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="3f5e0-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="3f5e0-218">V `ContosoUniversity` projektu, spusťte *Departments.aspx* stránce a pokuste se změnit správce pro oddělení na uživatele, který je již správce jiného oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="3f5e0-219">(Mějte na paměti, že lze upravit pouze oddělení, které jste přidali během tohoto kurzu, protože databáze obsahuje předem pomocí neplatná data.) Zobrazí se následující chybová stránka serveru:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="3f5e0-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="3f5e0-221">Nechcete, aby uživatelům zobrazit tento druh chybovou stránku, takže budete muset přidat kód pro zpracování chyb.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="3f5e0-222">Otevřít *Departments.aspx* a určit obslužnou rutinu pro `OnUpdated` událost `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="3f5e0-223">`ObjectDataSource` Počáteční značce teď vypadá podobně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="3f5e0-224">V *Departments.aspx.cs*, přidejte následující `using` – příkaz:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="3f5e0-225">Přidejte následující obslužnou rutinu pro `Updated` události:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="3f5e0-226">Pokud `ObjectDataSource` ovládací prvek zachytí výjimku při pokusu provést aktualizaci, předá výjimku v argumentu události (`e`) k této obslužné rutiny.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="3f5e0-227">Kód v obslužné rutině zkontroluje, jestli výjimka je výjimka duplicitní správce.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="3f5e0-228">Pokud se jedná, kód vytvoří ovládací prvek ověření, který obsahuje chybovou zprávu pro `ValidationSummary` ovládací prvek pro zobrazení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="3f5e0-229">Spuštění stránky a pokuste se opět někdo správce dvě oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="3f5e0-230">Tentokrát `ValidationSummary` ovládací prvek zobrazí chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="3f5e0-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="3f5e0-232">Provádět podobné změny *DepartmentsAdd.aspx* stránky.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="3f5e0-233">V *DepartmentsAdd.aspx*, zadejte obslužnou rutinu pro `OnInserted` událost `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="3f5e0-234">Výsledný kód bude vypadat podobně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="3f5e0-235">V *DepartmentsAdd.aspx.cs*, přidejte stejné `using` – příkaz:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="3f5e0-236">Přidejte následující obslužnou rutinu události:</span><span class="sxs-lookup"><span data-stu-id="3f5e0-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="3f5e0-237">Teď můžete otestovat *DepartmentsAdd.aspx.cs* stránku a ověřte, že správně zpracovává pokusí se jedna osoba správce více než jednom oddělení.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="3f5e0-238">Dokončení tohoto postupu Úvod k implementaci modelu úložiště pro použití `ObjectDataSource` ovládací prvek s Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="3f5e0-239">Další informace o použitému vzoru úložišť a možnost testování, najdete v dokumentu MSDN White Paper [testovatelnost a Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="3f5e0-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="3f5e0-240">V následujícím kurzu uvidíte, jak přidat řazení a filtrování funkce, které aplikace.</span><span class="sxs-lookup"><span data-stu-id="3f5e0-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="3f5e0-241">[Předchozí](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [další](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="3f5e0-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
