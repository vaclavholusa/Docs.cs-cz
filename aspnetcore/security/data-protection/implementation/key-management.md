---
title: Správa klíčů v ASP.NET Core
author: rick-anderson
description: Přečtěte si podrobnosti implementace správy klíčů na ochranu dat ASP.NET Core API.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 431bdf2d3076c83279b78f327ddb647f69e6e584
ms.sourcegitcommit: 8f8924ce4eb9effeaf489f177fb01b66867da16f
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 07/24/2018
ms.locfileid: "39219248"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="5988d-103">Správa klíčů v ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="5988d-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="5988d-104">Systém ochrany dat automaticky spravuje životnost hlavního klíče používané k ochraně a zrušení ochrany datových částí.</span><span class="sxs-lookup"><span data-stu-id="5988d-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="5988d-105">Každý klíč může existovat v jednom ze čtyř fází:</span><span class="sxs-lookup"><span data-stu-id="5988d-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="5988d-106">Vytvořená: klíč existuje v aktualizační kanál, který klíč, ale ještě nebyl aktivován.</span><span class="sxs-lookup"><span data-stu-id="5988d-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="5988d-107">Klíč nesmí použít pro nové operace ochrany až do uplynutí dostatečné doby, že klíč má využili příležitost dobře se rozšíří do všech počítačů, které spotřebovávají kanál klíč.</span><span class="sxs-lookup"><span data-stu-id="5988d-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="5988d-108">Aktivní - klíč existuje v aktualizační kanál, který klíč a slouží pro všechny nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="5988d-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="5988d-109">Vypršela platnost – klíč proběhla přirozené dobu života a již nelze použít pro nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="5988d-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="5988d-110">Odvolat – klíč dojde k ohrožení a nesmí se používat pro nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="5988d-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="5988d-111">Všechny vytvořené, aktivní a vypršela platnost klíče může používají k zrušení ochrany datových částí pro APN příchozí.</span><span class="sxs-lookup"><span data-stu-id="5988d-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="5988d-112">Odvolané klíče ve výchozím nastavení se nedají použít k zrušení ochrany datových částí, ale může vývojář aplikace [toto chování přepsat](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) v případě potřeby.</span><span class="sxs-lookup"><span data-stu-id="5988d-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="5988d-113">Vývojáři mohou mít tendenci získat odstranění klíče z klíče okruhu (například tak, že odstraníte odpovídající soubor ze systému souborů).</span><span class="sxs-lookup"><span data-stu-id="5988d-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="5988d-114">V tomto okamžiku je trvale undecipherable všechna data chráněná pomocí klíče a neexistuje žádná nouzový přepsání, jako je s odvolanými klíči.</span><span class="sxs-lookup"><span data-stu-id="5988d-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="5988d-115">Odstraňuje se klíč je skutečně destruktivní chování a v důsledku toho systém pro ochranu dat poskytuje žádné prvotřídní rozhraní API k provedení této operace.</span><span class="sxs-lookup"><span data-stu-id="5988d-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="5988d-116">Výchozí výběr klíče</span><span class="sxs-lookup"><span data-stu-id="5988d-116">Default key selection</span></span>

<span data-ttu-id="5988d-117">Když systém ochrany dat čte aktualizační kanál, který klíč ze záložního úložiště, pokusí se najít klíč "Výchozí" z aktualizační kanál, který klíč.</span><span class="sxs-lookup"><span data-stu-id="5988d-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="5988d-118">Výchozí klíč se používá pro nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="5988d-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="5988d-119">Obecné heuristiky je, že systém pro ochranu dat stiskne klávesu s poslední datum aktivace jako výchozí klíč.</span><span class="sxs-lookup"><span data-stu-id="5988d-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="5988d-120">(Není faktor malé hry fudge umožňující hodiny na serveru zkosení.) Pokud klíč vyprší nebo odvolán, a pokud se aplikace nezakázala automatické generování klíče, pak se vygeneruje nový klíč s okamžitou aktivaci za [klíčů vypršení platnosti a vrácení](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) zásad níže.</span><span class="sxs-lookup"><span data-stu-id="5988d-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="5988d-121">Z důvodu ochrany systému dat vygeneruje nový klíč okamžitě místo považován za jiný klíč je, že vygenerování nového klíče mají být považována za implicitní vypršení platnosti všechny klíče, které byly aktivovány před novým klíčem.</span><span class="sxs-lookup"><span data-stu-id="5988d-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="5988d-122">Obecnou myšlenku je, že nové klíče může být nakonfigurován se různé algoritmy nebo mechanismů šifrování v klidovém stavu než staré klíče a systému měli dát přednost aktuální konfiguraci přes návrat.</span><span class="sxs-lookup"><span data-stu-id="5988d-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="5988d-123">Dojde k výjimce.</span><span class="sxs-lookup"><span data-stu-id="5988d-123">There's an exception.</span></span> <span data-ttu-id="5988d-124">Pokud má vývojář aplikace [zakázané automatické generování klíčů](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), zvolte systém ochrany dat musí něco jako výchozí klíč.</span><span class="sxs-lookup"><span data-stu-id="5988d-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="5988d-125">V tomto scénáři záložní systém zvolí klíč – zrušeno s poslední datum aktivace přednost ke klíčům, které jste využili čas potřebný k šíření do dalších počítačů v clusteru se.</span><span class="sxs-lookup"><span data-stu-id="5988d-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="5988d-126">Záložní systém uvíznout v důsledku výběru vypršela platnost výchozí klíče.</span><span class="sxs-lookup"><span data-stu-id="5988d-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="5988d-127">Záložní systém zvolí nikdy odvolané klíč jako výchozí klíč, a pokud aktualizační kanál, který klíč je prázdný nebo každý klíč byl odvolán. potom systému dojde k chybě při inicializaci.</span><span class="sxs-lookup"><span data-stu-id="5988d-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="5988d-128">Vypršení platnosti klíče a se zajištěním provozu</span><span class="sxs-lookup"><span data-stu-id="5988d-128">Key expiration and rolling</span></span>

<span data-ttu-id="5988d-129">Při vytvoření klíče je automaticky přiřazen k aktivaci {now + 2 dny} a datum vypršení platnosti {now + 90 dní}.</span><span class="sxs-lookup"><span data-stu-id="5988d-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="5988d-130">Zpoždění 2 dny před aktivací poskytuje klíče čas potřebný k šíření prostřednictvím systému.</span><span class="sxs-lookup"><span data-stu-id="5988d-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="5988d-131">To znamená umožňuje sledovat klíč v jejich dalšího období automatické aktualizace, tím taky maximalizujete pravděpodobnost, že když klíč vyzvánět fakturuje se stane aktivní, které se rozšíří na všechny aplikace, které může být nutné použít jiné aplikace odkazuje na záložní úložiště.</span><span class="sxs-lookup"><span data-stu-id="5988d-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="5988d-132">Pokud výchozí klíč vyprší během dvou dnů a aktualizační kanál, který klíč ještě nemá klíč, který bude aktivováno po vypršení platnosti klíče výchozí, pak systém ochrany dat se automaticky zachová nový klíč na klíč kanál.</span><span class="sxs-lookup"><span data-stu-id="5988d-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="5988d-133">Tento nový klíč má datum aktivace {datum vypršení platnosti výchozí klíč} a datum vypršení platnosti {now + 90 dní}.</span><span class="sxs-lookup"><span data-stu-id="5988d-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="5988d-134">To umožňuje systému automatickou změnu klíče v pravidelných intervalech bez přerušení služby.</span><span class="sxs-lookup"><span data-stu-id="5988d-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="5988d-135">Můžou nastat okolnosti kde klíče se vytvoří s okamžitou aktivaci.</span><span class="sxs-lookup"><span data-stu-id="5988d-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="5988d-136">Jedním z příkladů se při nebyla na dobu spuštění aplikace a všechny klíče v aktualizační kanál, který klíč buď vypršela platnost.</span><span class="sxs-lookup"><span data-stu-id="5988d-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="5988d-137">Pokud k tomu dojde, dostane klíč datum aktivace {nyní} bez zpoždění normální 2denním aktivace.</span><span class="sxs-lookup"><span data-stu-id="5988d-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="5988d-138">Výchozí doba platnosti klíče je 90 dnů, ačkoli se dají konfigurovat jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="5988d-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="5988d-139">Správce může také změnit výchozí systémová, i když explicitní volání konstruktoru `SetDefaultKeyLifetime` přepíše všechny zásady v rámci systému.</span><span class="sxs-lookup"><span data-stu-id="5988d-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="5988d-140">Výchozí doba platnosti klíče nemůže být kratší než 7 dní.</span><span class="sxs-lookup"><span data-stu-id="5988d-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="5988d-141">Aktualizace automatického aktualizačního kanálu klíč</span><span class="sxs-lookup"><span data-stu-id="5988d-141">Automatic key ring refresh</span></span>

<span data-ttu-id="5988d-142">Když inicializuje systém ochrany dat, čte aktualizační kanál, který klíč ze základního úložiště a ukládá do mezipaměti v paměti.</span><span class="sxs-lookup"><span data-stu-id="5988d-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="5988d-143">Tato mezipaměť umožňuje chránit a Unprotect operace pokračovat bez dosažení záložního úložiště.</span><span class="sxs-lookup"><span data-stu-id="5988d-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="5988d-144">Systém automaticky zkontroluje záložní úložiště pro změny přibližně každých 24 hodin nebo když vyprší platnost aktuálního klíče výchozí, podle toho, co nastane dřív.</span><span class="sxs-lookup"><span data-stu-id="5988d-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="5988d-145">Vývojáři by měl velmi zřídka (Pokud někdy) potřeba použít správu klíčů rozhraní API přímo.</span><span class="sxs-lookup"><span data-stu-id="5988d-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="5988d-146">Systém ochrany dat provede automatické správy klíčů, jak je popsáno výše.</span><span class="sxs-lookup"><span data-stu-id="5988d-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="5988d-147">Systém pro ochranu dat poskytuje rozhraní `IKeyManager` , který můžete použít ke kontrole a provést změny aktualizační kanál, který klíč.</span><span class="sxs-lookup"><span data-stu-id="5988d-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="5988d-148">DI systém, který poskytuje instance `IDataProtectionProvider` můžete také zadat instanci `IKeyManager` pro spotřebu.</span><span class="sxs-lookup"><span data-stu-id="5988d-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="5988d-149">Alternativně si můžete vyžádat `IKeyManager` přímo z `IServiceProvider` stejně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="5988d-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="5988d-150">Všechny operace, která upravuje klíč prstenec (explicitně vytváření nového klíče nebo při provádění odvolání) zruší platnost mezipaměti v paměti.</span><span class="sxs-lookup"><span data-stu-id="5988d-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="5988d-151">Další volání `Protect` nebo `Unprotect` způsobí, že systém ochrany dat znovu načíst klíč okruh a znovu vytvořit mezipaměť.</span><span class="sxs-lookup"><span data-stu-id="5988d-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="5988d-152">Následující příklad ukazuje použití `IKeyManager` rozhraní ke kontrole a manipulaci s klíč okruh, včetně odvoláním existující klíče a generuje se nový klíč ručně.</span><span class="sxs-lookup"><span data-stu-id="5988d-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="5988d-153">Úložiště klíčů</span><span class="sxs-lookup"><span data-stu-id="5988d-153">Key storage</span></span>

<span data-ttu-id="5988d-154">Systém ochrany dat má heuristické metody, které se pokusí odvodit příslušné úložiště klíčů umístění a mechanismus šifrování v klidovém stavu automaticky.</span><span class="sxs-lookup"><span data-stu-id="5988d-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="5988d-155">Trvalost klíče mechanismus je také možné konfigurovat vývojář aplikace.</span><span class="sxs-lookup"><span data-stu-id="5988d-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="5988d-156">Tyto dokumenty popisují implementace v poli z těchto mechanismů:</span><span class="sxs-lookup"><span data-stu-id="5988d-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
